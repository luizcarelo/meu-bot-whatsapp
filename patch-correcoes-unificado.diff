
diff --git a/controllers/AuthController.js b/controllers/AuthController.js
index 1111111..2222222 100644
--- a/controllers/AuthController.js
+++ b/controllers/AuthController.js
@@ -1,20 +1,20 @@
 // Arquivo: controllers/AuthController.js 
 // Controlador de Autenticação - Login, Recuperação de Senha e Troca de Senha 
 const bcrypt = require('bcryptjs'); 
 const nodemailer = require('nodemailer'); 
 const crypto = require('crypto'); 
 // Configuração do Transporter de E-mail 
-const transporter = nodemailer.createTransport({ 
-  host: process.env.SMTP_HOST \ 'smtp.gmail.com', 
-  port: process.env.SMTP_PORT \ 587, 
-  secure: false, // true para 465, false para outras portas 
-  auth: { 
-    user: process.env.SMTP_USER, 
-    pass: process.env.SMTP_PASS 
-  } 
-}); 
+const transporter = nodemailer.createTransport({ 
+  host: process.env.SMTP_HOST || 'smtp.gmail.com', 
+  port: Number(process.env.SMTP_PORT) || 587, 
+  secure: false, // true para 465, false para outras portas 
+  auth: { 
+    user: process.env.SMTP_USER, 
+    pass: process.env.SMTP_PASS 
+  } 
+}); 
@@ -90,7 +90,7 @@
   // 7. Prepara Mensagens Padrão 
   let mensagensPadrao = []; 
   try { 
-    mensagensPadrao = JSON.parse(user.mensagens_padrao \ '[]'); 
+    mensagensPadrao = JSON.parse(user.mensagens_padrao || '[]'); 
   } catch (e) { 
     console.error('[Auth] Erro ao parsear mensagens_padrao:', e); 
   } 
@@ -104,7 +104,7 @@
   config: { 
     logo: user.logo_url, 
-    cor: user.cor_primaria \ '#4f46e5', 
+    cor: user.cor_primaria || '#4f46e5', 
     msgs: mensagensPadrao 
   }, 
   usuario: { 
     id: user.id, 
     nome: user.nome, 
     email: user.email, 
     is_admin: user.is_admin 
   } 
 }); 
diff --git a/controllers/AdminController.js b/controllers/AdminController.js
index 3333333..4444444 100644
--- a/controllers/AdminController.js
+++ b/controllers/AdminController.js
@@ -35,12 +35,12 @@
   // 3. FORMATAR DADOS 
-  const clientesFormatados = clientes.map(cliente => ({ 
-    ...cliente, 
-    created_at: new Date(cliente.created_at).toLocaleDateString('pt-BR'), 
-    uso_percentual: Math.round((cliente.total_users / cliente.limite_usuarios) * 100), 
-    status_whatsapp: cliente.whatsapp_status \ 'DESCONECTADO' 
-  })); 
+  const clientesFormatados = clientes.map(cliente => ({ 
+    ...cliente, 
+    created_at: new Date(cliente.created_at).toLocaleDateString('pt-BR'), 
+    uso_percentual: Math.round(((cliente.total_users || 0) / (cliente.limite_usuarios || 1)) * 100), 
+    status_whatsapp: cliente.whatsapp_status || 'DESCONECTADO' 
+  })); 
@@ -120,8 +120,8 @@
   const [resEmp] = await conn.execute( 
     `INSERT INTO empresas ( 
       nome, 
       plano, 
       limite_usuarios, 
       ativo, 
       mensagens_padrao, 
       welcome_media_type, 
       cor_primaria, 
       msg_ausencia, 
       msg_avaliacao, 
       horario_inicio, 
       horario_fim, 
       dias_funcionamento, 
       created_at 
     ) VALUES (?, ?, ?, 1, ?, 'texto', '#4f46e5', 
     'Olá! Nosso horário de atendimento é de segunda a sexta, das 8h às 18h. Retornaremos assim que possível.', 
     'Obrigado pelo contato! Por favor, avalie nosso atendimento de 1 a 5.', 
     '08:00', '18:00', ?, NOW())`, 
-    [ 
-      nome, 
-      plano \ 'pro', 
-      limite_usuarios \ 5, 
-      JSON.stringify(msgsPadrao), 
-      JSON.stringify(['seg', 'ter', 'qua', 'qui', 'sex']) 
-    ] 
+    [ 
+      nome, 
+      (plano || 'pro'), 
+      (limite_usuarios || 5), 
+      JSON.stringify(msgsPadrao), 
+      JSON.stringify(['seg', 'ter', 'qua', 'qui', 'sex']) 
+    ] 
   ); 
diff --git a/controllers/CrmController.js b/controllers/CrmController.js
index 5555555..6666666 100644
--- a/controllers/CrmController.js
+++ b/controllers/CrmController.js
@@ -60,77 +60,95 @@
-async getContatos(req, res) { 
-  const userId = req.headers['x-user-id']; 
-  const statusFiltro = req.query.status; 
-  // Verifica se é admin 
-  const [users] = await this.db.execute('SELECT is_admin FROM usuarios_painel WHERE id = ?', [userId]); 
-  // is_admin pode vir como 1/0 (número) ou true/false (booleano), convertemos para booleano 
-  const isAdmin = users[0] && (users[0].is_admin == 1 \ users[0].is_admin === true); 
-  let sql = ` 
-  SELECT c.*, 
-    (SELECT conteudo FROM mensagens m WHERE m.remote_jid = c.telefone AND m.empresa_id = c.empresa_id ORDER BY id DESC LIMIT 1) as ultima_msg, 
-    (SELECT data_hora FROM mensagens m WHERE m.remote_jid = c.telefone AND m.empresa_id = c.empresa_id ORDER BY id DESC LIMIT 1) as ordenacao, 
-    s.nome as nome_setor, 
-    s.cor as cor_setor, 
-    u.nome as nome_atendente 
-  FROM contatos c 
-  LEFT JOIN setores s ON c.setor_id = s.id 
-  LEFT JOIN usuarios_painel u ON c.atendente_id = u.id 
-  WHERE c.empresa_id = ? 
-  `; 
-  if (statusFiltro === 'meus') { 
-    // Meus: Apenas os que eu estou atendendo 
-    sql += ` AND c.status_atendimento = 'ATENDENDO' AND c.atendente_id = ${this.db.escape(userId)}`; 
-  } else if (statusFiltro === 'fila') { 
-    sql += ` AND c.status_atendimento = 'FILA'`; 
-    if (!isAdmin) { 
-      sql += ` AND c.setor_id IN (SELECT setor_id FROM usuarios_setores WHERE usuario_id = ${this.db.escape(userId)})`; 
-    } 
-  } else if (statusFiltro === 'todos') { 
-    if (isAdmin) { 
-      sql += ` AND c.status_atendimento IN ('ATENDENDO', 'FILA', 'ABERTO')`; 
-    } else { 
-      sql += ` AND ( 
-        (c.status_atendimento = 'FILA' AND c.setor_id IN (SELECT setor_id FROM usuarios_setores WHERE usuario_id = ${this.db.escape(userId)})) 
-        OR 
-        (c.status_atendimento = 'ATENDENDO' AND c.atendente_id = ${this.db.escape(userId)}) 
-      )`; 
-    } 
-  } 
-  sql += ` ORDER BY CASE WHEN ordenacao IS NULL THEN 0 ELSE 1 END, ordenacao DESC`; 
-  const [rows] = await this.db.execute(sql, [req.empresaId]); 
-  res.json(rows); 
-} 
+async getContatos(req, res) { 
+  const userId = req.headers['x-user-id']; 
+  const statusFiltro = req.query.status; 
+  try { 
+    const [users] = await this.db.execute('SELECT is_admin FROM usuarios_painel WHERE id = ?', [userId]); 
+    const isAdmin = users[0] && (users[0].is_admin == 1 || users[0].is_admin === true); 
+    let sql = ` 
+      SELECT c.*, 
+        (SELECT conteudo FROM mensagens m WHERE m.remote_jid = c.telefone AND m.empresa_id = c.empresa_id ORDER BY id DESC LIMIT 1) as ultima_msg, 
+        (SELECT data_hora FROM mensagens m WHERE m.remote_jid = c.telefone AND m.empresa_id = c.empresa_id ORDER BY id DESC LIMIT 1) as ordenacao, 
+        s.nome as nome_setor, 
+        s.cor as cor_setor, 
+        u.nome as nome_atendente 
+      FROM contatos c 
+      LEFT JOIN setores s ON c.setor_id = s.id 
+      LEFT JOIN usuarios_painel u ON c.atendente_id = u.id 
+      WHERE c.empresa_id = ? 
+    `; 
+    const params = [req.empresaId]; 
+    if (statusFiltro === 'meus') { 
+      sql += ` AND c.status_atendimento = 'ATENDENDO' AND c.atendente_id = ?`; 
+      params.push(userId); 
+    } else if (statusFiltro === 'fila') { 
+      sql += ` AND c.status_atendimento = 'FILA'`; 
+      if (!isAdmin) { 
+        sql += ` AND c.setor_id IN (SELECT setor_id FROM usuarios_setores WHERE usuario_id = ?)`; 
+        params.push(userId); 
+      } 
+    } else if (statusFiltro === 'todos') { 
+      if (isAdmin) { 
+        sql += ` AND c.status_atendimento IN ('ATENDENDO','FILA','ABERTO')`; 
+      } else { 
+        sql += ` AND ( 
+          (c.status_atendimento = 'FILA' AND c.setor_id IN (SELECT setor_id FROM usuarios_setores WHERE usuario_id = ?)) 
+          OR 
+          (c.status_atendimento = 'ATENDENDO' AND c.atendente_id = ?) 
+        )`; 
+        params.push(userId, userId); 
+      } 
+    } 
+    sql += ` ORDER BY CASE WHEN ordenacao IS NULL THEN 0 ELSE 1 END, ordenacao DESC`; 
+    const [rows] = await this.db.execute(sql, params); 
+    res.json(rows); 
+  } catch (e) { 
+    console.error(e); 
+    res.status(500).json({ error: 'Erro ao buscar contatos' }); 
+  } 
+} 
@@ -160,12 +178,12 @@
-const [u] = await this.db.execute('SELECT nome FROM usuarios_painel WHERE id = ?', [atendenteId]); 
-const nome = u[0]?.nome \ 'Um atendente'; 
+const [u] = await this.db.execute('SELECT nome FROM usuarios_painel WHERE id = ?', [atendenteId]); 
+const nome = u[0]?.nome || 'Um atendente'; 
@@ -185,9 +203,9 @@
-const [setor] = await this.db.execute('SELECT mensagem_saudacao, nome FROM setores WHERE id = ?', [setorId]); 
-const msg = setor[0]?.mensagem_saudacao \ `Transferindo para ${setor[0]?.nome \ 'o setor'}.`; 
+const [setor] = await this.db.execute('SELECT mensagem_saudacao, nome FROM setores WHERE id = ?', [setorId]); 
+const msg = setor[0]?.mensagem_saudacao || `Transferindo para ${setor[0]?.nome || 'o setor'}.`; 
@@ -214,8 +232,8 @@
-const [user] = await this.db.execute('SELECT nome FROM usuarios_painel WHERE id = ?', [usuarioId]); 
-const nomeUser = user[0]?.nome \ 'Outro atendente'; 
+const [user] = await this.db.execute('SELECT nome FROM usuarios_painel WHERE id = ?', [usuarioId]); 
+const nomeUser = user[0]?.nome || 'Outro atendente'; 
@@ -238,8 +256,8 @@
-const [empresa] = await this.db.execute('SELECT msg_avaliacao FROM empresas WHERE id = ?', [req.empresaId]); 
-const msgEncerramento = empresa[0].msg_avaliacao \ padrao; 
+const [empresa] = await this.db.execute('SELECT msg_avaliacao FROM empresas WHERE id = ?', [req.empresaId]); 
+const msgEncerramento = empresa[0].msg_avaliacao || padrao; 
@@ -290,7 +308,7 @@
-  [req.empresaId, nome, mensagem, mediaUrl, mediaType, cor \ '#cbd5e1'] 
+  [req.empresaId, nome, mensagem, mediaUrl, mediaType, (cor || '#cbd5e1')] 
@@ -360,6 +378,29 @@
+// NOVO: Agenda (rota já existe em routes/api.js)
+async getAgenda(req, res) {
+  try {
+    const [rows] = await this.db.execute(`
+      SELECT c.*, s.nome as nome_setor
+      FROM contatos c
+      LEFT JOIN setores s ON c.setor_id = s.id
+      WHERE c.empresa_id = ?
+      ORDER BY c.nome ASC
+    `, [req.empresaId]);
+    res.json(rows);
+  } catch (e) {
+    res.status(500).json({ error: 'Erro ao carregar agenda' });
+  }
+}
@@ -400,12 +431,18 @@
-const { nome, email, senha, is_admin, setores, telefone, cargo, ativo } = req.body; 
+const { nome, email, senha, is_admin, setores, telefone, cargo, ativo } = req.body; 
+const bcrypt = require('bcryptjs'); 
+const senhaHash = await bcrypt.hash(senha, 10); 
@@ -415,7 +452,7 @@
-  [req.empresaId, nome, email, senha, is_admin ? 1 : 0, telefone, cargo, ativo ? 1 : 0] 
+  [req.empresaId, nome, email, senhaHash, is_admin ? 1 : 0, telefone, cargo, ativo ? 1 : 0] 
@@ -500,10 +537,10 @@
-let captionFinal = caption \ ''; 
+let captionFinal = caption || ''; 
@@ -525,7 +562,7 @@
-const conteudoSalvo = tipo === 'audio' ? (caption \ req.file.originalname) : captionFinal; 
+const conteudoSalvo = tipo === 'audio' ? (caption || req.file.originalname) : captionFinal; 
 
diff --git a/controllers/WhatsAppController.js b/controllers/WhatsAppController.js
index 7777777..8888888 100644
--- a/controllers/WhatsAppController.js
+++ b/controllers/WhatsAppController.js
@@ -75,7 +75,7 @@
- let captionFinal = caption \ ''; 
+ let captionFinal = caption || ''; 
@@ -106,7 +106,7 @@
- const conteudoSalvo = tipo === 'audio' ? (caption \ req.file.originalname) : captionFinal; 
+ const conteudoSalvo = tipo === 'audio' ? (caption || req.file.originalname) : captionFinal; 
 
diff --git a/routes/api.js b/routes/api.js
index 9999999..aaaaaaa 100644
--- a/routes/api.js
+++ b/routes/api.js
@@ -120,6 +120,7 @@
 // ROTAS DO CRM - AGENDA E USUÁRIOS 
 router.get('/crm/agenda', (req, res) => 
   crmCtrl.getAgenda(req, res) 
 ); 
+// (mantida; método implementado no CrmController)
 
diff --git a/script/backup_database.js b/script/backup_database.js
index bbbbbbb..ccccccc 100644
--- a/script/backup_database.js
+++ b/script/backup_database.js
@@ -35,7 +35,7 @@
- const timestamp = new Date().toISOString().replace(/\[:.\]/g, '-').split('T')[0] + '_' +
+ const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' +
   new Date().toTimeString().split(' ')[0].replace(/:/g, '-'); 
 
diff --git a/script/reset_databse.js b/script/reset_database.js
similarity index 100%
rename from script/reset_databse.js
rename to script/reset_database.js
