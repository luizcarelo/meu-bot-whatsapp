<!DOCTYPE html>
<html lang="pt-br" class="<%= typeof isMobile !== 'undefined' && isMobile ? 'mobile-mode' : 'desktop-mode' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title><%= titulo %></title>
    
    <link href="/css/style.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        const IS_MOBILE_ROUTE = "<%= typeof isMobile !== 'undefined' && isMobile ? 'true' : 'false' %>" === "true";
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { primary: 'var(--color-primary)', chatbg: '#efeae2', chatbgdark: '#0b141a' },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                } 
            } 
        }
    </script>
    <style>
        :root { --color-primary: #4f46e5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overscroll-behavior-y: none; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Mensagens */
        .msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 14px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); position: relative; word-wrap: break-word; }
        .msg-in { background: #ffffff; border-radius: 0 12px 12px 12px; align-self: flex-start; margin-right: auto; border-top-left-radius: 0; }
        .msg-out { background: #d9fdd3; border-radius: 12px 0 12px 12px; align-self: flex-end; margin-left: auto; border-top-right-radius: 0; }
        
        .dark .msg-in { background: #202c33; color: #e9edef; } 
        .dark .msg-out { background: #005c4b; color: #e9edef; }
        
        /* Fundo */
        .chat-background { background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); opacity: 0.9; }
        .dark .chat-background { background-color: #0b141a; background-blend-mode: soft-light; opacity: 1; }
        
        /* Modal Tags */
        .tag-badge { font-size: 10px; padding: 2px 6px; border-radius: 12px; font-weight: 600; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 overflow-hidden bg-white dark:bg-slate-900">

    <div id="toast" class="fixed top-5 right-5 z-[999] bg-slate-800 text-white px-4 py-3 rounded shadow-lg transform translate-x-full transition duration-300 flex items-center gap-3 border-l-4 border-indigo-500">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">...</span>
    </div>

    <div class="flex h-full w-full relative overflow-hidden">
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-96 bg-white border-r flex flex-col z-20 shadow-lg dark:bg-slate-900 dark:border-slate-700 absolute md:relative h-full transition-transform duration-300 flex-shrink-0">
            <div class="p-4 bg-slate-100 dark:bg-slate-800 border-b dark:border-slate-700 h-16 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <img id="crm-logo" class="w-8 h-8 rounded object-cover hidden">
                    <h2 class="font-bold text-sm dark:text-white truncate max-w-[140px]" id="crm-empresa-nome">Carregando...</h2>
                </div>
                <div class="flex gap-1 text-slate-500 items-center">
                    <button onclick="toggleNewChatModal()" title="Nova Conversa" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center justify-center"><i class="fas fa-plus"></i></button>
                    <button onclick="abrirAgenda()" title="Agenda Global" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center justify-center"><i class="fas fa-address-book"></i></button>
                    <button onclick="toggleDarkMode()" title="Tema" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center justify-center"><i class="fas fa-moon"></i></button>
                    <button onclick="logout()" title="Sair" class="w-8 h-8 rounded-full hover:bg-red-100 text-red-500 dark:hover:bg-red-900/30 transition flex items-center justify-center"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            
            <div class="flex justify-around border-b bg-white dark:bg-slate-900 text-[11px] uppercase font-bold shrink-0">
                <button onclick="mudarAbaFila('meus')" id="tab-meus" class="tab-active py-3 flex-1 hover:bg-slate-50 dark:hover:bg-slate-800 transition">Meus</button>
                <button onclick="mudarAbaFila('fila')" id="tab-fila" class="tab-inactive py-3 flex-1 hover:bg-slate-50 dark:hover:bg-slate-800 transition">Fila</button>
                <button onclick="mudarAbaFila('todos')" id="tab-todos" class="tab-inactive py-3 flex-1 hover:bg-slate-50 dark:hover:bg-slate-800 transition">Todos</button>
            </div>
            
            <div class="p-3 shrink-0 bg-white dark:bg-slate-900">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                    <input id="input-busca" onkeyup="filtrarContatos()" placeholder="Buscar conversa..." class="w-full bg-slate-100 dark:bg-slate-800 rounded-lg pl-9 pr-3 py-2 text-sm outline-none dark:text-white focus:ring-2 focus:ring-indigo-500 transition border border-transparent focus:border-indigo-500">
                </div>
            </div>
            
            <div id="lista-contatos" class="flex-1 overflow-y-auto min-h-0 scroll-smooth px-2 pb-2 space-y-1"></div>
            
            <div id="sidebar-footer" class="p-3 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 mt-auto">
                 <button id="btn-admin-panel" onclick="window.location.href='/admin/painel'" class="hidden w-full bg-white border border-slate-200 text-slate-700 text-xs py-2.5 rounded-lg font-bold hover:bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:hover:bg-slate-600 transition flex items-center justify-center gap-2 shadow-sm">
                    <i class="fas fa-cog"></i> ADMINISTRAÇÃO
                </button>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div id="chat-wrapper" class="absolute inset-0 z-30 bg-white dark:bg-slate-950 w-full h-full flex flex-col md:static md:flex-1 transition-transform duration-300 transform translate-x-full md:translate-x-0">
            <!-- Header -->
            <div class="h-16 bg-white dark:bg-slate-800 border-b dark:border-slate-700 flex items-center px-4 justify-between shadow-sm z-10 shrink-0">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    <button onclick="voltarLista()" class="md:hidden text-slate-500 p-2 hover:bg-slate-100 rounded-full transition"><i class="fas fa-arrow-left"></i></button>
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 font-bold overflow-hidden border border-slate-100 dark:border-slate-600" id="avatar-chat">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="min-w-0 cursor-pointer" onclick="toggleCRM()">
                        <h3 id="chat-title" class="font-bold text-sm dark:text-white truncate">Selecione uma conversa</h3>
                        <p id="chat-status" class="text-xs text-slate-400 truncate">...</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 shrink-0" id="chat-actions">
                    <!-- Botão Etiquetas -->
                    <button onclick="abrirModalTags()" id="btn-tags" class="hidden h-9 px-3 bg-slate-100 text-slate-600 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-200 transition text-xs font-bold dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 border border-slate-200 dark:border-slate-600" title="Gerenciar Etiquetas">
                        <i class="fas fa-tag"></i> <span class="hidden sm:inline">Etiquetas</span>
                    </button>
                    
                    <button onclick="assumirTicket()" id="btn-assumir" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow transition flex items-center gap-2"><i class="fas fa-hand-paper"></i> ASSUMIR</button>
                    
                    <div id="actions-atendendo" class="hidden flex gap-2">
                        <button onclick="abrirModalTransfer()" class="h-9 w-9 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center hover:bg-orange-200 transition shadow-sm border border-orange-200" title="Transferir"><i class="fas fa-exchange-alt"></i></button>
                        <button onclick="encerrarTicket()" class="h-9 w-9 bg-red-100 text-red-600 rounded-lg flex items-center justify-center hover:bg-red-200 transition shadow-sm border border-red-200" title="Encerrar"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>

            <!-- Corpo -->
            <div id="chat-bg" class="flex-1 chat-background relative overflow-hidden flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 scroll-smooth pb-4"></div>
            </div>

            <!-- Input -->
            <div id="input-area" class="bg-white dark:bg-slate-800 p-3 border-t dark:border-slate-700 hidden relative shrink-0">
                <div id="quick-msgs-popup" class="absolute bottom-20 left-4 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border dark:border-slate-600 w-72 max-h-80 overflow-y-auto hidden z-50 animate-fade-in">
                    <div class="p-3 border-b dark:border-slate-600 text-xs font-bold text-slate-500 dark:text-slate-300 bg-slate-50 dark:bg-slate-700 sticky top-0">Mensagens Rápidas</div>
                    <div id="quick-msgs-list" class="divide-y divide-slate-100 dark:divide-slate-700"></div>
                </div>
                
                <div id="audio-recorder-ui" class="hidden flex items-center gap-4 p-3 bg-red-50 dark:bg-slate-700/50 rounded-xl mb-2 border border-red-100 dark:border-slate-600">
                    <div class="w-3 h-3 rounded-full bg-red-500 recording-anim"></div>
                    <span id="recording-time" class="text-sm font-mono dark:text-white font-bold flex-1">00:00</span>
                    <button onclick="cancelarAudio()" class="text-red-500 text-sm font-bold hover:underline">Cancelar</button>
                    <button onclick="enviarAudioGravado()" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition shadow-sm"><i class="fas fa-paper-plane text-xs"></i></button>
                </div>
                
                <div class="flex items-end gap-2" id="text-input-ui">
                    <button onclick="toggleQuickMsgs()" class="text-slate-400 hover:text-yellow-500 p-3 rounded-full transition hover:bg-slate-100 dark:hover:bg-slate-700" title="Mensagens Rápidas"><i class="fas fa-bolt text-lg"></i></button>
                    <label class="cursor-pointer text-slate-400 hover:text-indigo-500 p-3 rounded-full transition hover:bg-slate-100 dark:hover:bg-slate-700" title="Anexar Arquivo"><i class="fas fa-paperclip text-lg"></i><input type="file" id="file-upload" class="hidden" onchange="enviarArquivo()"></label>
                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-2xl flex items-center border border-transparent focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500 transition">
                        <textarea id="input-msg" rows="1" class="w-full bg-transparent py-3 px-4 outline-none text-sm resize-none dark:text-white max-h-32" placeholder="Digite sua mensagem..."></textarea>
                    </div>
                    <button id="btn-mic" onclick="iniciarGravacao()" class="bg-indigo-600 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition hover:bg-indigo-700 active:scale-95" title="Gravar Áudio"><i class="fas fa-microphone"></i></button>
                    <button id="btn-send" onclick="enviarMsg()" class="bg-indigo-600 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center hidden transition hover:bg-indigo-700 active:scale-95" title="Enviar"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ETIQUETAS (VISUAL NOVO) -->
    <div id="modal-tags" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white p-0 rounded-xl shadow-2xl w-full max-w-sm dark:bg-slate-800 overflow-hidden flex flex-col max-h-[80vh] border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <h3 class="font-bold text-base dark:text-white flex items-center gap-2"><i class="fas fa-tags text-indigo-500"></i> Etiquetas</h3>
                <button onclick="document.getElementById('modal-tags').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-400 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="lista-tags-disponiveis" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center text-slate-400 text-sm py-8 flex flex-col items-center gap-2">
                    <i class="fas fa-circle-notch fa-spin"></i> Carregando...
                </div>
            </div>
            <div class="p-3 bg-slate-50 border-t dark:bg-slate-900 dark:border-slate-700 text-center">
                <a href="/admin/painel" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center justify-center gap-2 p-2 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition">
                    <i class="fas fa-plus-circle"></i> Gerenciar Etiquetas no Admin
                </a>
            </div>
        </div>
    </div>

    <!-- OUTROS MODAIS -->
    <div id="modal-transfer" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md dark:bg-slate-800 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-slate-700"><h3 class="font-bold dark:text-white">Transferir</h3><button onclick="document.getElementById('modal-transfer').classList.add('hidden')" class="text-slate-400"><i class="fas fa-times"></i></button></div>
            <div class="flex border-b dark:border-slate-700"><button onclick="mudarAbaTransfer('setor')" id="tab-transf-setor" class="flex-1 py-3 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600">Setor</button><button onclick="mudarAbaTransfer('usuario')" id="tab-transf-usuario" class="flex-1 py-3 text-sm text-slate-500">Usuário</button></div>
            <div id="view-transf-setor" class="p-2 max-h-60 overflow-y-auto"><div id="lista-setores-transf" class="space-y-1"></div></div>
            <div id="view-transf-usuario" class="hidden p-2 max-h-60 overflow-y-auto"><div id="lista-usuarios-transf" class="space-y-1"></div></div>
        </div>
    </div>

    <div id="modal-agenda" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg h-[80vh] flex flex-col dark:bg-slate-800">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between"><h3 class="font-bold dark:text-white">Agenda</h3><button onclick="document.getElementById('modal-agenda').classList.add('hidden')" class="text-slate-400"><i class="fas fa-times"></i></button></div>
            <div class="p-4"><input id="agenda-search" onkeyup="filtrarAgenda()" placeholder="Buscar..." class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white"></div>
            <div id="lista-agenda" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </div>
    </div>

    <div id="modal-novo-chat" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm dark:bg-slate-800">
            <h3 class="font-bold text-lg mb-4 dark:text-white">Nova Conversa</h3>
            <input id="new-chat-tel" placeholder="Telefone (55...)" class="w-full border p-2 rounded mb-3 dark:bg-slate-700 dark:text-white">
            <input id="new-chat-name" placeholder="Nome" class="w-full border p-2 rounded mb-4 dark:bg-slate-700 dark:text-white">
            <div class="flex justify-end gap-2"><button onclick="toggleNewChatModal()" class="px-4 py-2 text-slate-500">Cancelar</button><button onclick="iniciarNovaConversa()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Iniciar</button></div>
        </div>
    </div>
    
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center"><i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i><p>Verificando acesso...</p></div>
    </div>

    <script>
        const socket = io();
        let session; try { session = JSON.parse(localStorage.getItem('saas_user')); } catch(e) { session = null; }
        
        if (!session || session.role !== 'cliente') { window.location.href='/login'; } 
        else { document.getElementById('login-screen').classList.add('hidden'); init(); }

        let currentChat = null, listaContatosCache = [], abaAtual = 'meus', quickMsgsCache = [], agendaCache = [];
        let mediaRecorder, audioChunks = [], recordingTimer, recordingTime = 0;
        const headers = () => ({ 'Content-Type': 'application/json', 'x-empresa-id': session ? session.empresaId : '', 'x-user-id': session ? session.usuario.id : '' });

        function init() {
            document.getElementById('crm-empresa-nome').innerText = session.empresaNome;
            if(session.config.logo) { document.getElementById('crm-logo').src = session.config.logo; document.getElementById('crm-logo').classList.remove('hidden'); }
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const isAdmin = session.usuario.is_admin == 1 || session.usuario.is_admin === true;
            if (isAdmin) { const btn = document.getElementById('btn-admin-panel'); if(btn) btn.classList.remove('hidden'); }

            socket.removeAllListeners();
            socket.emit('join_empresa', session.empresaId);
            
            socket.on('connect', () => { console.log('Reconectado'); socket.emit('join_empresa', session.empresaId); });
            
            socket.on('nova_mensagem', d => { 
                if(currentChat) {
                    const chatNum = currentChat.telefone.replace(/\D/g, '');
                    const msgNum = d.remoteJid.replace(/\D/g, '');
                    if(chatNum === msgNum) addMsg(d.conteudo, !!d.fromMe, d.tipo, d.urlMidia); 
                }
                carregarContatos(); 
            });
            
            socket.on('atualizar_lista', () => carregarContatos());
            carregarSetores(); carregarContatos(); carregarQuickMsgs();
            
            // Input Enter
            const input = document.getElementById('input-msg');
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarMsg(); } });
            input.addEventListener('input', () => { 
                const hasText = input.value.trim().length > 0;
                document.getElementById('btn-mic').classList.toggle('hidden', hasText);
                document.getElementById('btn-send').classList.toggle('hidden', !hasText);
                input.style.height = 'auto'; input.style.height = (input.scrollHeight) + 'px';
            });
        }

        function addMsg(conteudo, me, tipo, urlMidia) { 
            const box = document.getElementById('chat-box'); 
            const div = document.createElement('div'); 
            div.className = `flex ${me ? 'justify-end' : 'justify-start'} mb-4 w-full fade-enter group`; 
            
            let html = '';
            const mediaSrc = urlMidia || conteudo;
            const isViewOnce = conteudo && typeof conteudo === 'string' && conteudo.includes('Visualização Única');

            if (tipo === 'texto') html = formatarTexto(conteudo || '');
            
            else if (tipo === 'imagem') {
                if (isViewOnce) {
                    html = `<div class="flex items-center gap-3 p-3 bg-slate-100 rounded-lg border border-slate-200 select-none dark:bg-slate-700 dark:border-slate-600"><div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center border border-blue-200"><i class="fas fa-eye-slash"></i></div><div><p class="text-xs font-bold text-slate-700 dark:text-white">Foto de Visualização Única</p><p class="text-[10px] text-slate-500">Por privacidade, não exibida aqui.</p></div></div>`;
                } else {
                    html = `<div class="relative"><img src="${mediaSrc}" class="rounded-lg max-w-[250px] cursor-pointer hover:opacity-95 shadow-sm" onclick="window.open('${mediaSrc}')">${conteudo && conteudo !== '[Imagem]' ? `<p class="mt-2 text-sm">${formatarTexto(conteudo)}</p>` : ''}</div>`;
                }
            }
            else if (tipo === 'video') {
                 if (isViewOnce) {
                    html = `<div class="flex items-center gap-3 p-3 bg-slate-100 rounded-lg border border-slate-200 select-none dark:bg-slate-700 dark:border-slate-600"><div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center border border-blue-200"><i class="fas fa-eye-slash"></i></div><div><p class="text-xs font-bold text-slate-700 dark:text-white">Vídeo de Visualização Única</p><p class="text-[10px] text-slate-500">Por privacidade, não exibido aqui.</p></div></div>`;
                } else {
                    html = `<video controls src="${mediaSrc}" class="rounded-lg max-w-[250px] shadow-sm"></video>${conteudo && conteudo !== '[Vídeo]' ? `<p class="mt-1 text-sm">${formatarTexto(conteudo)}</p>` : ''}`;
                }
            }
            else if (tipo === 'audio') html = `<div class="flex flex-col gap-1 min-w-[200px]"><div class="flex items-center gap-2"><i class="fas fa-microphone text-slate-400"></i><audio controls src="${mediaSrc}" class="h-8 w-full max-w-[220px]"></audio></div>${(conteudo && conteudo.includes('Transcrição')) ? `<div class="mt-1 text-xs italic bg-black/5 p-2 rounded border border-black/10 dark:bg-white/10 dark:border-white/10 text-slate-600 dark:text-slate-300">${conteudo}</div>` : ''}</div>`;
            else if (tipo === 'documento') html = `<a href="${mediaSrc}" target="_blank" class="flex items-center gap-3 bg-slate-100 p-3 rounded-lg hover:bg-slate-200 transition border border-slate-200 dark:bg-slate-700 dark:border-slate-600 dark:hover:bg-slate-600"><div class="bg-red-500 text-white w-10 h-10 rounded flex items-center justify-center text-lg shadow-sm"><i class="fas fa-file-alt"></i></div><div class="overflow-hidden"><div class="text-sm font-bold truncate max-w-[180px] dark:text-white">${conteudo.replace(/> ↳.*?_/, '').trim() || 'Documento'}</div><div class="text-xs text-slate-500 uppercase">Arquivo</div></div><i class="fas fa-download text-slate-400 ml-auto"></i></a>`;
            else if (tipo === 'localizacao') {
                try { const loc = JSON.parse(conteudo); html = `<a href="https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}" target="_blank" class="block bg-orange-50 border border-orange-100 rounded-lg overflow-hidden hover:opacity-90 transition dark:bg-slate-800 dark:border-slate-600 shadow-sm group-hover:shadow"><div class="h-32 bg-orange-100 flex items-center justify-center text-orange-400 relative"><i class="fas fa-map-marker-alt text-4xl animate-bounce"></i><div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div></div><div class="p-3"><div class="font-bold text-sm text-slate-800 dark:text-white flex items-center gap-2"><i class="fas fa-location-dot text-orange-500"></i> Localização</div>${loc.address ? `<div class="text-xs text-slate-500 truncate mt-1">${loc.address}</div>` : ''}</div></a>`; } catch(e) { html = 'Localização'; }
            }
            else if (tipo === 'contato') {
                try { const c = JSON.parse(conteudo); const telMatch = (c.vcard || '').match(/waid=(\d+)/) || (c.vcard || '').match(/TEL;.*?:(.*)/); const tel = telMatch ? telMatch[1].replace(/\D/g,'') : ''; html = `<div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex items-center gap-3 min-w-[240px] dark:bg-slate-800 dark:border-slate-600 shadow-sm"><div class="w-12 h-12 rounded-full bg-white text-blue-600 flex items-center justify-center font-bold text-xl shadow-sm border border-blue-100">${c.displayName ? c.displayName[0] : '#'}</div><div class="flex-1 min-w-0"><div class="font-bold text-sm text-slate-800 dark:text-white truncate">${c.displayName || 'Contato'}</div><div class="text-xs text-slate-500">${tel}</div></div><button onclick="iniciarNovaConversaManual('${tel}', '${c.displayName}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition"><i class="fas fa-comment-dots text-lg"></i></button></div>`; } catch(e) { html = 'Contato'; }
            }
            else if (tipo === 'enquete') {
                try { const poll = JSON.parse(conteudo); html = `<div class="bg-yellow-50 border border-yellow-100 rounded-lg p-4 min-w-[260px] dark:bg-slate-800 dark:border-slate-600 shadow-sm"><div class="font-bold text-sm text-slate-800 mb-3 flex items-center gap-2 dark:text-white"><i class="fas fa-poll text-yellow-600"></i> ${poll.name}</div><div class="space-y-2">${poll.options.map(opt => `<div class="bg-white/60 border border-yellow-200 rounded px-3 py-2 text-xs text-slate-700 flex items-center gap-2 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-500"><div class="w-3 h-3 rounded-full border border-slate-400"></div> ${opt}</div>`).join('')}</div></div>`; } catch(e) { html = 'Enquete'; }
            }

            const bubbleClass = me ? 'msg-out' : 'msg-in'; 
            div.innerHTML = `<div class="msg-bubble ${bubbleClass} shadow-sm group-hover:shadow-md transition duration-200">${html}<div class="text-[9px] opacity-50 text-right mt-1 select-none flex items-center justify-end gap-1">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${me ? '<i class="fas fa-check-double"></i>' : ''}</div></div>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight; 
        }

        // --- Renderização de Contatos (Com Tags) ---
        function renderContatos(lista) {
            const el = document.getElementById('lista-contatos'); 
            if(lista.length === 0) return el.innerHTML = '<div class="text-center p-10 text-slate-400 text-sm">Nenhuma conversa encontrada.</div>';
            
            el.innerHTML = lista.map(c => {
                const active = (currentChat && currentChat.telefone === c.telefone) ? 'bg-indigo-50 dark:bg-slate-800 border-l-4 border-indigo-600' : 'hover:bg-slate-50 dark:hover:bg-slate-800';
                const avatarUrl = c.foto_perfil ? c.foto_perfil : `https://ui-avatars.com/api/?name=${c.nome||'U'}&background=random`;
                const avatar = `<img src="${avatarUrl}" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${c.nome||'U'}&background=random'" class="w-10 h-10 rounded-full object-cover shrink-0">`;
                
                let tagsHtml = '';
                if (c.tags) { 
                    try { 
                        const t = typeof c.tags === 'string' ? JSON.parse(c.tags) : c.tags; 
                        if(Array.isArray(t) && t.length > 0) {
                            tagsHtml = `<div class="flex gap-1 mt-1.5 flex-wrap">${t.slice(0, 3).map(tag => 
                                `<span class="tag-badge" style="background-color:${tag.cor};">${tag.nome}</span>`
                            ).join('')}${t.length > 3 ? `<span class="tag-badge bg-slate-300 text-slate-600">+${t.length-3}</span>` : ''}</div>`;
                        }
                    } catch(e){} 
                }

                return `<div onclick='selecionarChat(${JSON.stringify(c)})' class="p-3 border-b dark:border-slate-700 cursor-pointer flex items-start gap-3 transition mx-0 ${active}">
                    ${avatar}
                    <div class="flex-1 min-w-0 overflow-hidden">
                        <div class="flex justify-between items-baseline mb-0.5">
                            <h4 class="font-bold text-sm truncate dark:text-white flex items-center gap-1">${c.nome || c.telefone} ${c.nome_setor ? `<span class="text-[9px] px-1.5 py-0.5 rounded text-white font-bold ml-1 uppercase whitespace-nowrap" style="background-color:${c.cor_setor||'#94a3b8'}">${c.nome_setor}</span>` : ''}</h4>
                            <span class="text-[10px] text-slate-400 shrink-0 ml-1">${c.ordenacao ? new Date(c.ordenacao).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate dark:text-slate-400">${c.ultima_msg || 'Nova conversa'}</p>
                        ${tagsHtml}
                    </div>
                </div>`;
            }).join('');
        }

        function formatarTexto(txt) { if(!txt) return ''; return txt.replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<b>$1</b>').replace(/_(.*?)_/g, '<i>$1</i>').replace(/~(.*?)~/g, '<strike>$1</strike>').replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 hover:underline break-all">$1</a>'); }
        
        async function carregarHistorico(tel) { const box = document.getElementById('chat-box'); box.innerHTML = '<div class="text-center p-5 text-slate-400 text-xs"><i class="fas fa-circle-notch fa-spin"></i></div>'; try { const res = await fetch(`/api/crm/mensagens/${tel}`, {headers: headers()}); const msgs = await res.json(); box.innerHTML = ''; msgs.forEach(m => addMsg(m.conteudo, !!m.from_me, m.tipo, m.url_midia)); } catch(e){ box.innerHTML='Erro.'; } }
        
        function selecionarChat(c) { 
            currentChat = c; 
            document.getElementById('chat-title').innerText = c.nome || c.telefone; 
            document.getElementById('chat-status').innerText = c.status_atendimento === 'FILA' ? 'Aguardando na Fila' : (c.status_atendimento === 'ATENDENDO' ? `Em atendimento por ${c.nome_atendente || 'você'}` : 'Aberto'); 
            
            if(window.innerWidth < 768) { 
                document.getElementById('sidebar').classList.add('hidden'); 
                document.getElementById('chat-wrapper').classList.remove('translate-x-full'); 
            } 
            
            const btnAssumir = document.getElementById('btn-assumir'); 
            const actions = document.getElementById('actions-atendendo'); 
            const inputArea = document.getElementById('input-area'); 
            const btnTags = document.getElementById('btn-tags'); 
            const isAdmin = session.usuario.is_admin == 1 || session.usuario.is_admin === true; 
            
            btnAssumir.classList.add('hidden'); 
            actions.classList.add('hidden'); 
            inputArea.classList.add('hidden'); 
            btnTags.classList.remove('hidden'); 
            
            if (c.status_atendimento === 'ATENDENDO' && c.atendente_id == session.usuario.id) { 
                actions.classList.remove('hidden'); 
                inputArea.classList.remove('hidden'); 
            } else if (c.status_atendimento === 'ATENDENDO' && isAdmin && c.atendente_id != session.usuario.id) { 
                btnAssumir.classList.remove('hidden'); 
                btnAssumir.innerText = "ASSUMIR (ADMIN)"; 
                inputArea.classList.add('hidden'); 
            } else if (c.status_atendimento === 'FILA') { 
                btnAssumir.classList.remove('hidden'); 
                btnAssumir.innerText = "ASSUMIR"; 
            } else if (c.status_atendimento === 'ABERTO') { 
                btnAssumir.classList.remove('hidden'); 
                btnAssumir.innerText = "INICIAR ATENDIMENTO"; 
            } 
            carregarHistorico(c.telefone); 
            renderContatos(listaContatosCache); 
        }

        async function assumirTicket() { if(!currentChat) return; const telefoneAlvo = currentChat.telefone; await fetch('/api/crm/atendimento/assumir', { method: 'POST', headers: headers(), body: JSON.stringify({ telefone: telefoneAlvo }) }); mudarAbaFila('meus'); setTimeout(async () => { await carregarContatos(); const novoContato = listaContatosCache.find(c => c.telefone === telefoneAlvo); if(novoContato) selecionarChat(novoContato); }, 500); }
        function mudarAbaFila(aba) { abaAtual = aba; document.querySelectorAll('[id^="tab-"]').forEach(t => t.className = 'tab-inactive py-3 flex-1 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition text-slate-500 dark:text-slate-400 border-b-2 border-transparent'); document.getElementById(`tab-${aba}`).className = 'tab-active py-3 flex-1 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer border-b-2 border-indigo-600 text-indigo-600 font-bold transition'; carregarContatos(); }
        async function carregarContatos() { try { const res = await fetch(`/api/crm/contatos?status=${abaAtual}`, {headers: headers()}); if(!res.ok) throw new Error(); listaContatosCache = await res.json(); filtrarContatos(); } catch(e) { console.error(e); } }
        function filtrarContatos() { const termo = document.getElementById('input-busca').value.toLowerCase(); const filtrados = listaContatosCache.filter(c => (c.nome && c.nome.toLowerCase().includes(termo)) || (c.telefone && c.telefone.includes(termo))); renderContatos(filtrados); }
        function voltarLista() { document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('chat-wrapper').classList.add('translate-x-full'); currentChat = null; }
        function toggleNewChatModal() { document.getElementById('modal-novo-chat').classList.toggle('hidden'); }
        async function iniciarNovaConversa() { const nome = document.getElementById('new-chat-name').value; const telefone = document.getElementById('new-chat-tel').value; if(!telefone) return alert("Digite o telefone."); try { const res = await fetch('/api/crm/contatos', { method: 'POST', headers: headers(), body: JSON.stringify({ nome, telefone }) }); const data = await res.json(); if(data.success) { toggleNewChatModal(); mudarAbaFila('meus'); setTimeout(() => { carregarContatos().then(() => { const contato = listaContatosCache.find(c => c.telefone.includes(telefone.replace(/\D/g,''))); if(contato) selecionarChat(contato); }); }, 1000); } else alert(data.error); } catch(e) { alert('Erro.'); } }
        async function enviarArquivo() { const f = document.getElementById('file-upload').files[0]; if (!f || !currentChat) return; const fd = new FormData(); fd.append('file', f); fd.append('telefone', currentChat.telefone); fd.append('caption', f.name); const h = { 'x-empresa-id': session.empresaId, 'x-user-id': session.usuario.id }; try { await fetch('/api/crm/enviar-midia', { method: 'POST', headers: h, body: fd }); document.getElementById('file-upload').value = ''; } catch(e) { alert('Erro.'); } }
        async function enviarMsg() { const txt = document.getElementById('input-msg').value; if(!txt) return; await fetch('/api/crm/enviar', { method: 'POST', headers: headers(), body: JSON.stringify({ telefone: currentChat.telefone, texto: txt }) }); document.getElementById('input-msg').value = ''; }
        async function encerrarTicket() { if(!confirm('Encerrar?')) return; await fetch('/api/crm/atendimento/encerrar', { method: 'POST', headers: headers(), body: JSON.stringify({ telefone: currentChat.telefone }) }); mudarAbaFila('meus'); if(window.innerWidth<768) voltarLista(); }
        async function fazerLogin() { const empresa = document.getElementById('login-empresa').value; const email = document.getElementById('login-email').value; const senha = document.getElementById('login-pass').value; if(!empresa || !email || !senha) return alert('Preencha todos os campos!'); try { const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ nomeEmpresa: empresa, email, senha }) }); const data = await res.json(); if(data.success) { localStorage.setItem('saas_user', JSON.stringify(data)); session = data; document.getElementById('login-screen').classList.add('hidden'); window.location.reload(); } else { alert(data.message || data.error || 'Erro no login'); } } catch(e) { console.error(e); alert('Erro de conexão ou servidor.'); } }
        function logout() { localStorage.removeItem('saas_user'); window.location.href = '/login'; }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
        async function carregarSetores() { const res = await fetch('/api/crm/setores', {headers: headers()}); const s = await res.json(); document.getElementById('lista-setores-transf').innerHTML = s.map(Setor => `<button onclick="transferir(${Setor.id})" class="w-full text-left p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded border dark:border-slate-600 mb-1"><span class="dark:text-white">${Setor.nome}</span></button>`).join(''); }
        function abrirModalTransfer() { document.getElementById('modal-transfer').classList.remove('hidden'); mudarAbaTransfer('setor'); }
        function mudarAbaTransfer(aba) { const bs = document.getElementById('tab-transf-setor'); const bu = document.getElementById('tab-transf-usuario'); const vs = document.getElementById('view-transf-setor'); const vu = document.getElementById('view-transf-usuario'); if(aba==='setor'){ bs.className="flex-1 py-2 text-sm font-bold modal-tab-active transition"; bu.className="flex-1 py-2 text-sm text-slate-500 dark:text-slate-400 hover:text-indigo-500 transition"; vs.classList.remove('hidden'); vu.classList.add('hidden'); } else { bu.className="flex-1 py-2 text-sm font-bold modal-tab-active transition"; bs.className="flex-1 py-2 text-sm text-slate-500 dark:text-slate-400 hover:text-indigo-500 transition"; vu.classList.remove('hidden'); vs.classList.add('hidden'); carregarUsuariosParaTransferencia(); } }
        async function carregarUsuariosParaTransferencia() { try { const res = await fetch('/api/crm/atendentes', {headers: headers()}); const users = await res.json(); document.getElementById('lista-usuarios-transf').innerHTML = users.filter(u => u.id != session.usuario.id && u.ativo).map(u => `<button onclick="transferirParaUsuario(${u.id})" class="w-full text-left p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded border dark:border-slate-600 mb-1 flex items-center justify-between transition"><span class="text-sm font-medium dark:text-white">${u.nome}</span><i class="fas fa-chevron-right text-xs text-slate-400"></i></button>`).join(''); } catch(e){} }
        async function transferirParaUsuario(uid) { if(!confirm('Transferir?')) return; await fetch('/api/crm/atendimento/transferir-usuario', { method: 'POST', headers: headers(), body: JSON.stringify({ telefone: currentChat.telefone, usuarioId: uid }) }); document.getElementById('modal-transfer').classList.add('hidden'); mudarAbaFila('meus'); }
        async function transferir(idSetor) { await fetch('/api/crm/atendimento/transferir', { method: 'POST', headers: headers(), body: JSON.stringify({ telefone: currentChat.telefone, setorId: idSetor }) }); document.getElementById('modal-transfer').classList.add('hidden'); carregarContatos(); }
        function abrirAgenda() { document.getElementById('modal-agenda').classList.remove('hidden'); filtrarAgenda(); fetch('/api/crm/agenda', {headers: headers()}).then(r=>r.json()).then(d => { agendaCache = d; filtrarAgenda(); }); }
        function filtrarAgenda() { const t = document.getElementById('agenda-search').value.toLowerCase(); const f = agendaCache.filter(c => (c.nome && c.nome.toLowerCase().includes(t)) || c.telefone.includes(t)); document.getElementById('lista-agenda').innerHTML = f.map(c => `<div onclick="iniciarConversaAgenda('${c.telefone}', '${c.nome}')" class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b dark:border-slate-700 flex items-center gap-3 rounded"><div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-500">${c.nome?c.nome[0]:'#'}</div><div><div class="font-bold text-sm dark:text-white">${c.nome||'Sem Nome'}</div><div class="text-xs text-slate-500">${c.telefone}</div></div></div>`).join(''); }
        function iniciarConversaAgenda(t, n) { document.getElementById('modal-agenda').classList.add('hidden'); document.getElementById('new-chat-tel').value = t; document.getElementById('new-chat-name').value = n; iniciarNovaConversa(); }
        async function carregarQuickMsgs() { const res = await fetch('/api/crm/mensagens-rapidas', {headers: headers()}); quickMsgsCache = await res.json(); }
        function toggleQuickMsgs() { const el = document.getElementById('quick-msgs-popup'); const list = document.getElementById('quick-msgs-list'); if(el.classList.contains('hidden')) { list.innerHTML = quickMsgsCache.map(m => `<div onclick="usarQuickMsg('${m.conteudo.replace(/'/g, "\\'")}')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-b dark:border-slate-700 transition"><div class="font-bold text-xs dark:text-white">${m.titulo}</div><div class="text-[10px] text-slate-500 truncate">${m.conteudo}</div></div>`).join(''); el.classList.remove('hidden'); } else el.classList.add('hidden'); }
        function usarQuickMsg(t) { const i = document.getElementById('input-msg'); i.value = t; i.focus(); document.getElementById('quick-msgs-popup').classList.add('hidden'); i.dispatchEvent(new Event('input')); }
        async function iniciarGravacao() { try { const s = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(s); audioChunks = []; mediaRecorder.ondataavailable = e => audioChunks.push(e.data); mediaRecorder.start(); document.getElementById('text-input-ui').classList.add('hidden'); document.getElementById('audio-recorder-ui').classList.remove('hidden'); recordingTime = 0; recordingTimer = setInterval(() => { recordingTime++; document.getElementById('recording-time').innerText = `${Math.floor(recordingTime/60).toString().padStart(2,'0')}:${(recordingTime%60).toString().padStart(2,'0')}`; }, 1000); } catch (e) { alert("Erro microfone."); } }
        function cancelarAudio() { if(mediaRecorder) mediaRecorder.stop(); clearInterval(recordingTimer); document.getElementById('audio-recorder-ui').classList.add('hidden'); document.getElementById('text-input-ui').classList.remove('hidden'); }
        function enviarAudioGravado() { if(!mediaRecorder) return; mediaRecorder.stop(); clearInterval(recordingTimer); mediaRecorder.onstop = async () => { const b = new Blob(audioChunks, { type: 'audio/mp3' }); const fd = new FormData(); fd.append('file', b, 'audio.mp3'); fd.append('telefone', currentChat.telefone); const h = { 'x-empresa-id': session.empresaId, 'x-user-id': session.usuario.id }; await fetch('/api/crm/enviar-midia', { method: 'POST', headers: h, body: fd }); document.getElementById('audio-recorder-ui').classList.add('hidden'); document.getElementById('text-input-ui').classList.remove('hidden'); }; }
        function iniciarNovaConversaManual(tel, nome) { document.getElementById('new-chat-tel').value = tel; document.getElementById('new-chat-name').value = nome; toggleNewChatModal(); }

        // --- FUNÇÕES DE ETIQUETAS ATUALIZADAS ---
        async function abrirModalTags() {
            if (!currentChat) return;
            document.getElementById('modal-tags').classList.remove('hidden');
            const listaDiv = document.getElementById('lista-tags-disponiveis');
            listaDiv.innerHTML = '<div class="text-center text-slate-400 text-xs py-4"><i class="fas fa-circle-notch fa-spin"></i> Carregando...</div>';
            
            try {
                // Busca todas as etiquetas da empresa
                const resTags = await fetch('/api/crm/etiquetas', {headers: headers()});
                const todasTags = await resTags.json();
                
                // Busca o contato atual da lista cacheada para ver quais tags ele já tem
                let tagsContatoIds = [];
                const contatoAtual = listaContatosCache.find(c => c.id === currentChat.id);
                
                if (contatoAtual && contatoAtual.tags) {
                    const t = typeof contatoAtual.tags === 'string' ? JSON.parse(contatoAtual.tags) : contatoAtual.tags;
                    if(Array.isArray(t)) tagsContatoIds = t.map(tag => tag.id);
                }

                if (todasTags.length === 0) { 
                    listaDiv.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">Nenhuma etiqueta criada.</div>'; 
                    return; 
                }

                listaDiv.innerHTML = todasTags.map(tag => {
                    const isChecked = tagsContatoIds.includes(tag.id) ? 'checked' : '';
                    return `
                    <label class="flex items-center justify-between p-3 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg cursor-pointer transition border border-transparent hover:border-slate-200 dark:hover:border-slate-600 mb-1">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full shadow-sm ring-2 ring-white dark:ring-slate-800" style="background-color: ${tag.cor}"></div>
                            <span class="text-sm font-medium dark:text-white">${tag.nome}</span>
                        </div>
                        <div class="relative flex items-center">
                            <input type="checkbox" onchange="toggleTag(${tag.id})" ${isChecked} class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 transition-all checked:border-indigo-600 checked:bg-indigo-600 hover:border-indigo-400 focus:outline-none dark:border-slate-500">
                            <i class="fas fa-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 text-xs pointer-events-none transition-opacity"></i>
                        </div>
                    </label>`;
                }).join('');
                
            } catch (e) { 
                console.error(e); 
                listaDiv.innerHTML = '<div class="text-center text-red-400 text-xs">Erro ao carregar etiquetas.</div>'; 
            }
        }

        async function toggleTag(tagId) { 
            if (!currentChat) return; 
            try { 
                await fetch('/api/crm/etiquetas/toggle', { 
                    method: 'POST', 
                    headers: headers(), 
                    body: JSON.stringify({ contatoId: currentChat.id, etiquetaId: tagId }) 
                }); 
                
                // Recarrega a lista para atualizar a visualização lateral
                await carregarContatos(); 
                
            } catch (e) { 
                alert('Erro ao alterar etiqueta.'); 
            } 
        }
    </script>
</body>
</html>