<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações da Empresa</title>
    <link href="/css/style.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { primary: 'var(--color-primary)', chatbg: '#efeae2', chatbgdark: '#0b141a' } 
                } 
            } 
        }
    </script>
    <style>
        :root { --color-primary: #4f46e5; }
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos de Abas */
        .tab-active { border-bottom: 2px solid var(--color-primary); color: var(--color-primary); font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
        .dark .tab-inactive { color: #94a3b8; }
        .dark .tab-inactive:hover { color: #e2e8f0; border-bottom: 2px solid #475569; }
        
        /* Cores Etiquetas */
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #475569; transform: scale(1.1); }

        /* Sortable ghost element */
        .sortable-ghost { opacity: 0.4; background-color: #f1f5f9; border: 2px dashed #cbd5e1; }
        .dark .sortable-ghost { background-color: #1e293b; border-color: #475569; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col dark:bg-slate-900 dark:text-white">

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-5 right-5 z-50 bg-slate-800 text-white px-4 py-3 rounded shadow-lg transform translate-x-full transition duration-300 border-l-4 border-indigo-500 flex items-center gap-3">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">...</span>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-slate-200 px-6 h-16 flex items-center justify-between sticky top-0 z-40 shadow-sm dark:bg-slate-800 dark:border-slate-700">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='/crm'" class="text-slate-500 hover:text-indigo-600 transition flex items-center gap-2 text-sm font-medium dark:text-slate-400 dark:hover:text-white">
                <i class="fas fa-arrow-left"></i> Voltar ao Chat
            </button>
            <div class="h-6 w-px bg-slate-200 dark:bg-slate-600"></div>
            <h1 class="font-bold text-lg tracking-tight">Painel Administrativo</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="text-slate-500 hover:text-indigo-600 transition mr-2 dark:text-slate-400 dark:hover:text-white"><i class="fas fa-moon"></i></button>
            <span class="text-[10px] font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded uppercase tracking-wide">Admin</span>
            <span id="header-empresa" class="text-sm font-bold text-slate-600 dark:text-slate-200">Carregando...</span>
        </div>
    </nav>

    <!-- CONTENT -->
    <div class="max-w-6xl mx-auto w-full p-6 flex-1 flex flex-col">

        <!-- TABS HEADER -->
        <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
            <div class="flex gap-6 overflow-x-auto pb-1 scrollbar-hide">
                <button onclick="mudarAba('conexao')" id="btn-conexao" class="tab-active pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fab fa-whatsapp text-lg"></i> Conexão</button>
                <button onclick="mudarAba('relatorios')" id="btn-relatorios" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-chart-bar"></i> Relatórios</button>
                <button onclick="mudarAba('setores')" id="btn-setores" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-project-diagram"></i> Fluxo</button>
                <button onclick="mudarAba('empresa')" id="btn-empresa" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-building"></i> Empresa</button>
                <button onclick="mudarAba('automacao')" id="btn-automacao" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-robot"></i> Automação & IA</button>
                <button onclick="mudarAba('mensagens-rapidas')" id="btn-mensagens-rapidas" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-bolt"></i> Msgs Rápidas</button>
                <button onclick="mudarAba('marketing')" id="btn-marketing" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-bullhorn"></i> Marketing</button>
                <button onclick="mudarAba('equipe')" id="btn-equipe" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-users"></i> Equipe</button>
                <button onclick="mudarAba('etiquetas')" id="btn-etiquetas" class="tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap"><i class="fas fa-tags"></i> Etiquetas</button>
            </div>
        </div>

        <div class="flex-1 relative">
            
            <!-- 1. ABA CONEXÃO -->
            <div id="tab-conexao" class="tab-content fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <div class="md:col-span-2 bg-white p-8 rounded-xl shadow-sm border border-slate-200 text-center dark:bg-slate-800 dark:border-slate-700">
                        <div class="mb-6"><div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fab fa-whatsapp"></i></div><h2 class="text-2xl font-bold">Conexão WhatsApp</h2></div>
                        <div class="flex justify-center mb-8"><div id="status-badge" class="px-4 py-2 rounded-full text-sm font-bold bg-slate-100 text-slate-500 flex items-center gap-2 border dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600"><div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div> Verificando...</div></div>
                        <div id="qr-wrapper" class="hidden bg-slate-50 p-6 rounded-xl border border-dashed border-slate-300 inline-block mb-6 dark:bg-slate-900 dark:border-slate-600"><p class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wide animate-pulse">Escaneie o QR Code</p><img id="qr-code" class="w-64 h-64 object-contain bg-white p-2 rounded shadow-sm mx-auto"></div>
                        <div class="flex justify-center gap-4"><button onclick="iniciarConexao()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-bold text-sm transition shadow-lg flex items-center gap-2"><i class="fas fa-plug"></i> CONECTAR</button><button onclick="resetarConexao()" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 px-6 py-2.5 rounded-lg font-bold text-sm transition flex items-center gap-2 dark:bg-slate-700 dark:border-slate-600"><i class="fas fa-power-off"></i> DESCONECTAR</button></div>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 h-fit dark:bg-slate-800 dark:border-slate-700">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 dark:text-slate-200"><i class="fas fa-file-alt text-blue-500"></i> Relatório de Sessão</h3>
                        <div class="space-y-4 text-sm"><div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Número Conectado</p><p class="font-mono font-bold break-all dark:text-white" id="rel-numero">--</p></div><div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Status Atual</p><span class="inline-block px-2 py-1 rounded text-xs font-bold bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300" id="rel-status">--</span></div><div><p class="text-xs text-slate-400 uppercase font-bold mb-1">Última Atualização</p><p class="text-slate-600 dark:text-slate-300" id="rel-data">--</p></div></div>
                    </div>
                </div>
            </div>

            <!-- 2. ABA RELATÓRIOS -->
            <div id="tab-relatorios" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <div class="text-xs font-bold text-slate-400 uppercase mb-2">Mensagens Totais</div>
                        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400" id="dash-msgs">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <div class="text-xs font-bold text-slate-400 uppercase mb-2">Contatos Ativos</div>
                        <div class="text-3xl font-bold text-emerald-600 dark:text-emerald-400" id="dash-contatos">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <div class="text-xs font-bold text-slate-400 uppercase mb-2">Equipe</div>
                        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="dash-equipe">0</div>
                    </div>
                </div>
                <!-- Avaliações -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="font-bold mb-4">Avaliações de Atendimento (Últimas 50)</h3>
                    <div class="flex items-center gap-4 mb-4">
                        <div class="text-4xl font-bold text-yellow-500" id="dash-nota">0.0</div>
                        <div class="text-sm text-slate-500">Média Geral</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-300">
                                <tr>
                                    <th class="px-4 py-3">Data</th>
                                    <th class="px-4 py-3">Cliente</th>
                                    <th class="px-4 py-3">Atendente</th>
                                    <th class="px-4 py-3">Nota</th>
                                    <th class="px-4 py-3">Comentário</th>
                                </tr>
                            </thead>
                            <tbody id="lista-avaliacoes" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. ABA FLUXO (SETORES) -->
            <div id="tab-setores" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-fit">
                        <h3 class="font-bold text-lg mb-4">Novo Setor</h3>
                        <div class="space-y-4">
                            <input id="setor-nome" placeholder="Nome do Setor (ex: Financeiro)" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600">
                            <textarea id="setor-msg" rows="3" placeholder="Mensagem de Saudação do Setor" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600"></textarea>
                            <input type="color" id="setor-cor" value="#64748b" class="w-full h-10 cursor-pointer">
                            <button onclick="criarSetor()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">ADICIONAR</button>
                        </div>
                    </div>
                    <div class="md:col-span-2 space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg">Setores Ativos</h3>
                            <span class="text-xs text-slate-400">Arraste para reordenar</span>
                        </div>
                        <div id="lista-setores" class="space-y-2"></div>
                        <button onclick="salvarOrdemSetores()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-700 transition"><i class="fas fa-save"></i> Salvar Ordem</button>
                    </div>
                </div>
            </div>

            <!-- 4. ABA EMPRESA -->
            <div id="tab-empresa" class="tab-content hidden fade-in">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 max-w-3xl mx-auto dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="font-bold text-lg mb-6 border-b pb-2 dark:border-slate-700">Dados Gerais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Nome da Empresa</label>
                            <input id="emp-nome" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Cor Primária</label>
                            <input id="emp-cor" type="color" class="w-full h-10 border p-1 rounded dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>

                    <h3 class="font-bold text-lg mb-6 border-b pb-2 dark:border-slate-700 pt-4">Mensagens Padrão</h3>
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Saudação (Menu Principal)</label>
                            <textarea id="emp-msgs" rows="3" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Ausência (Fora do Horário)</label>
                            <textarea id="emp-ausencia" rows="3" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Finalização/Avaliação</label>
                            <textarea id="emp-avaliacao" rows="3" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600"></textarea>
                        </div>
                    </div>

                    <h3 class="font-bold text-lg mb-6 border-b pb-2 dark:border-slate-700 pt-4">Horário de Atendimento</h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div><label class="text-xs">Início</label><input type="time" id="emp-inicio" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white"></div>
                        <div><label class="text-xs">Fim</label><input type="time" id="emp-fim" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white"></div>
                    </div>

                    <button onclick="salvarEmpresa()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 transition">SALVAR ALTERAÇÕES</button>
                </div>
            </div>

            <!-- 5. ABA AUTOMAÇÃO (IA) -->
            <div id="tab-automacao" class="tab-content hidden fade-in">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 max-w-3xl mx-auto dark:bg-slate-800 dark:border-slate-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-brain text-purple-500"></i> Configuração OpenAI (ChatGPT)</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="ia-ativo" class="w-5 h-5 rounded text-indigo-600">
                            <span class="font-bold text-sm">IA Ativa</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">API Key OpenAI</label>
                            <input id="ia-key" type="password" placeholder="sk-..." class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Prompt do Sistema (Personalidade)</label>
                            <textarea id="ia-prompt" rows="8" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600" placeholder="Você é um assistente virtual da empresa X..."></textarea>
                            <p class="text-xs text-slate-400 mt-1">Defina como a IA deve se comportar, o que ela sabe sobre a empresa e limites de resposta.</p>
                        </div>
                        <button onclick="salvarIA()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-purple-700 transition">SALVAR IA</button>
                    </div>
                </div>
            </div>

            <!-- 6. ABA MENSAGENS RÁPIDAS -->
            <div id="tab-mensagens-rapidas" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-fit">
                        <h3 class="font-bold text-lg mb-4">Nova Mensagem</h3>
                        <div class="space-y-4">
                            <input id="quick-titulo" placeholder="Título (ex: Pix)" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600">
                            <input id="quick-atalho" placeholder="Atalho (ex: /pix)" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600">
                            <textarea id="quick-conteudo" rows="4" placeholder="Conteúdo da mensagem..." class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white dark:border-slate-600"></textarea>
                            <button onclick="criarQuickMsg()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">CRIAR</button>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Mensagens Cadastradas</h3>
                        <div id="lista-quick" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- 7. ABA MARKETING -->
            <div id="tab-marketing" class="tab-content hidden fade-in">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 max-w-2xl mx-auto text-center dark:bg-slate-800 dark:border-slate-700">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-bullhorn"></i></div>
                    <h2 class="text-2xl font-bold mb-2">Disparo em Massa (Broadcast)</h2>
                    <p class="text-slate-500 mb-6 text-sm">Envie uma mensagem para <b>TODOS</b> os contatos salvos na base. Use com cautela.</p>
                    
                    <textarea id="mkt-msg" rows="5" class="w-full border p-3 rounded-lg mb-4 dark:bg-slate-700 dark:text-white dark:border-slate-600" placeholder="Digite sua mensagem de divulgação..."></textarea>
                    
                    <button onclick="enviarBroadcast()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition flex items-center gap-2 mx-auto">
                        <i class="fas fa-paper-plane"></i> INICIAR DISPARO
                    </button>
                    <p id="mkt-status" class="mt-4 text-xs font-bold text-slate-400 hidden">Enviando...</p>
                </div>
            </div>

            <!-- 
  ========================================
  ABA: CONFIGURAÇÃO DE HORÁRIOS (Enterprise)
  Inserir este bloco HTML onde você deseja que a tabela apareça
  ========================================
-->
<div id="tab-horarios" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Configuração de Horário de Atendimento</h2>
    
    <div class="overflow-x-auto">
        <form id="form-horarios">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4 border-b text-left">Dia da Semana</th>
                        <th class="py-2 px-4 border-b text-center">Aberto?</th>
                        <th class="py-2 px-4 border-b text-center">Abertura</th>
                        <th class="py-2 px-4 border-b text-center">Fechamento</th>
                        <th class="py-2 px-4 border-b text-center">Início Almoço</th>
                        <th class="py-2 px-4 border-b text-center">Fim Almoço</th>
                    </tr>
                </thead>
                <tbody id="tabela-horarios-body">
                    <!-- Linhas serão preenchidas via JS -->
                    <tr><td colspan="6" class="text-center py-4">Carregando horários...</td></tr>
                </tbody>
            </table>

            <div class="mt-4 flex justify-end">
                <button type="button" onclick="salvarHorarios()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow transition duration-200">
                    Salvar Alterações
                </button>
            </div>
        </form>
    </div>
</div>


            <!-- 8. ABA EQUIPE -->
            <div id="tab-equipe" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-fit">
                        <h3 class="font-bold text-lg mb-4">Novo Usuário</h3>
                        <div class="space-y-3">
                            <input id="user-nome" placeholder="Nome" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white">
                            <input id="user-email" placeholder="Email" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white">
                            <input id="user-senha" type="password" placeholder="Senha" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white">
                            <input id="user-tel" placeholder="Telefone (WhatsApp)" class="w-full border p-2 rounded dark:bg-slate-700 dark:text-white">
                            <label class="flex items-center gap-2"><input type="checkbox" id="user-admin"> Admin?</label>
                            
                            <div class="border-t pt-2 dark:border-slate-600">
                                <p class="text-xs font-bold mb-2">Setores Permitidos:</p>
                                <div id="lista-setores-user" class="space-y-1 max-h-32 overflow-y-auto"></div>
                            </div>
                            
                            <button onclick="criarUsuario()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">CRIAR USUÁRIO</button>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Membros da Equipe</h3>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-300">
                                    <tr>
                                        <th class="px-4 py-3">Nome</th>
                                        <th class="px-4 py-3">Email</th>
                                        <th class="px-4 py-3">Cargo</th>
                                        <th class="px-4 py-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-equipe" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 9. ABA ETIQUETAS (NOVA) -->
            <div id="tab-etiquetas" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Form -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <h3 class="font-bold text-lg mb-6 dark:text-white flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm"><i class="fas fa-plus"></i></div>
                            Nova Etiqueta
                        </h3>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1.5 block uppercase tracking-wide">Nome da Etiqueta</label>
                                <input id="tag-nome" placeholder="Ex: Cliente VIP" class="w-full border border-slate-300 p-3 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-2 block uppercase tracking-wide">Cor da Etiqueta</label>
                                <div class="flex flex-wrap gap-2 mb-3" id="color-palette">
                                    <div class="color-option bg-red-500" onclick="selectColor('#ef4444')"></div>
                                    <div class="color-option bg-orange-500" onclick="selectColor('#f97316')"></div>
                                    <div class="color-option bg-amber-500" onclick="selectColor('#f59e0b')"></div>
                                    <div class="color-option bg-green-500" onclick="selectColor('#22c55e')"></div>
                                    <div class="color-option bg-emerald-500" onclick="selectColor('#10b981')"></div>
                                    <div class="color-option bg-teal-500" onclick="selectColor('#14b8a6')"></div>
                                    <div class="color-option bg-cyan-500" onclick="selectColor('#06b6d4')"></div>
                                    <div class="color-option bg-sky-500" onclick="selectColor('#0ea5e9')"></div>
                                    <div class="color-option bg-blue-500" onclick="selectColor('#3b82f6')"></div>
                                    <div class="color-option bg-indigo-500" onclick="selectColor('#6366f1')"></div>
                                    <div class="color-option bg-violet-500" onclick="selectColor('#8b5cf6')"></div>
                                    <div class="color-option bg-purple-500" onclick="selectColor('#a855f7')"></div>
                                    <div class="color-option bg-fuchsia-500" onclick="selectColor('#d946ef')"></div>
                                    <div class="color-option bg-pink-500" onclick="selectColor('#ec4899')"></div>
                                    <div class="color-option bg-rose-500" onclick="selectColor('#f43f5e')"></div>
                                    <div class="color-option bg-slate-500" onclick="selectColor('#64748b')"></div>
                                </div>
                                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200 dark:bg-slate-700 dark:border-slate-600">
                                    <input type="color" id="tag-cor" value="#64748b" class="h-8 w-12 rounded cursor-pointer border-0 p-0 bg-transparent">
                                    <span id="tag-cor-hex" class="text-sm font-mono text-slate-600 dark:text-slate-300">#64748b</span>
                                </div>
                            </div>
                            
                            <button onclick="salvarTag()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-save"></i> CRIAR ETIQUETA
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista -->
                    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg dark:text-white flex items-center gap-2">
                                <i class="fas fa-tags text-slate-400"></i> Etiquetas Cadastradas
                            </h3>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full font-bold dark:bg-slate-700 dark:text-slate-300" id="count-tags">0</span>
                        </div>
                        
                        <div id="lista-tags-admin" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[500px] overflow-y-auto pr-2">
                            <div class="col-span-full text-center py-10 text-slate-400 text-sm flex flex-col items-center"><i class="fas fa-tags text-4xl mb-3 opacity-20"></i><p>Nenhuma etiqueta criada ainda.</p></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- 1. SETUP INICIAL ---
        const socket = io();
        const session = JSON.parse(localStorage.getItem('saas_user'));
        const headers = { 'Content-Type': 'application/json', 'x-empresa-id': session ? session.empresaId : '' };
        const currentEmpresaId = session ? session.empresaId : null;

        if(!session || session.role !== 'cliente') window.location.href = '/crm';
        
        // Elementos Globais
        document.getElementById('header-empresa').innerText = session.empresaNome;
        if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        
        // Entra na sala da empresa
        socket.emit('join_empresa', currentEmpresaId);

        // --- 2. GERENCIAMENTO DE ABAS ---
        function mudarAba(abaId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${abaId}`).classList.remove('hidden');
            
            // Atualiza botões
            const botoes = ['conexao', 'relatorios', 'setores', 'empresa', 'automacao', 'mensagens-rapidas', 'marketing', 'equipe', 'etiquetas'];
            botoes.forEach(b => {
                const btn = document.getElementById(`btn-${b}`);
                if (btn) {
                    if (b === abaId) {
                        btn.className = "tab-active pb-3 text-sm transition px-1 flex items-center gap-2 whitespace-nowrap";
                    } else {
                        btn.className = "tab-inactive pb-3 text-sm transition px-1 flex items-center gap-2 cursor-pointer whitespace-nowrap";
                    }
                }
            });

            // Lazy Load
            if(abaId === 'relatorios') carregarRelatorios();
            if(abaId === 'empresa') carregarEmpresa();
            if(abaId === 'automacao') carregarAutomacao();
            if(abaId === 'mensagens-rapidas') carregarQuickMsgs();
            if(abaId === 'equipe') carregarEquipe();
            if(abaId === 'setores') carregarSetores();
            if(abaId === 'etiquetas') carregarTagsAdmin();
        }

        // --- 3. CONEXÃO WHATSAPP ---
        async function carregarDados() {
            if(!document.querySelector('.tab-active')) mudarAba('conexao');
            try {
                const res = await fetch('/api/crm/config', {headers});
                const d = await res.json();
                document.getElementById('rel-numero').innerText = d.whatsapp_numero || 'Não conectado';
                document.getElementById('rel-status').innerText = d.whatsapp_status || 'DESCONECTADO';
                document.getElementById('rel-data').innerText = d.whatsapp_updated_at ? new Date(d.whatsapp_updated_at).toLocaleString() : '--';
            } catch(e) {}
        }
        carregarDados();

        async function iniciarConexao() {
            document.getElementById('status-badge').innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-yellow-400 animate-pulse"></div> Iniciando...';
            try { await fetch('/whatsapp/start', { method: 'POST', headers, body: JSON.stringify({ empresaId: currentEmpresaId }) }); } 
            catch(e) { showToast('Erro ao iniciar', 'error'); }
        }
        
        async function resetarConexao() {
            if(!confirm('Deseja realmente desconectar?')) return;
            try { await fetch('/whatsapp/logout', { method: 'POST', headers, body: JSON.stringify({ empresaId: currentEmpresaId }) }); } catch(e) {}
        }

        // Listeners Socket para QR Code
        function handleQr(qr) {
             console.log('QR Recebido', qr ? 'com dados' : 'vazio');
             document.getElementById('qr-wrapper').classList.remove('hidden');
             document.getElementById('qr-code').src = qr;
             document.getElementById('status-badge').innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-blue-400 animate-pulse"></div> Aguardando Leitura';
        }

        socket.on('qr_code', (data) => handleQr(data.qr || data));
        socket.on('qrcode', (data) => handleQr(data.qr || data));
        socket.on('qr', (data) => handleQr(data.qr || data));

        socket.on('whatsapp_ready', () => {
            document.getElementById('qr-wrapper').classList.add('hidden');
            document.getElementById('status-badge').innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-green-500"></div> Conectado';
            showToast('WhatsApp Conectado!', 'success');
            carregarDados();
        });

        // --- 4. RELATÓRIOS ---
        async function carregarRelatorios() {
            try {
                // Dashboard
                const res = await fetch('/api/crm/dashboard', {headers});
                const d = await res.json();
                document.getElementById('dash-msgs').innerText = d.mensagens;
                document.getElementById('dash-contatos').innerText = d.contatos;
                document.getElementById('dash-equipe').innerText = d.equipe;

                // Avaliações
                const resAv = await fetch('/api/crm/avaliacoes', {headers});
                const av = await resAv.json();
                document.getElementById('dash-nota').innerText = av.media || '0.0';
                document.getElementById('lista-avaliacoes').innerHTML = av.lista.map(a => `
                    <tr class="bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                        <td class="px-4 py-3">${new Date(a.data_avaliacao).toLocaleDateString()}</td>
                        <td class="px-4 py-3">${a.nome_cliente || a.contato_telefone}</td>
                        <td class="px-4 py-3">${a.nome_atendente || '-'}</td>
                        <td class="px-4 py-3 font-bold text-yellow-500">${a.nota} <i class="fas fa-star text-[10px]"></i></td>
                        <td class="px-4 py-3 italic text-slate-500">${a.comentario || ''}</td>
                    </tr>
                `).join('');
            } catch(e) {}
        }

        // --- 5. FLUXO (SETORES) ---
        async function carregarSetores() {
            const res = await fetch('/api/crm/setores', {headers});
            const setores = await res.json();
            const lista = document.getElementById('lista-setores');
            lista.innerHTML = setores.map(s => `
                <div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm cursor-move dark:bg-slate-800 dark:border-slate-700" data-id="${s.id}">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full" style="background-color: ${s.cor}"></div>
                        <div>
                            <div class="font-bold dark:text-white">${s.nome}</div>
                            <div class="text-xs text-slate-500 truncate max-w-xs">${s.mensagem_saudacao}</div>
                        </div>
                    </div>
                    <button onclick="deletarSetor(${s.id})" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
            
            new Sortable(lista, { animation: 150, ghostClass: 'sortable-ghost' });
        }

        async function criarSetor() {
            const nome = document.getElementById('setor-nome').value;
            const msg = document.getElementById('setor-msg').value;
            const cor = document.getElementById('setor-cor').value;
            if(!nome) return showToast('Nome obrigatório', 'error');

            await fetch('/api/crm/setores', { method: 'POST', headers, body: JSON.stringify({ nome, mensagem: msg, cor }) });
            showToast('Setor criado!', 'success');
            document.getElementById('setor-nome').value = '';
            carregarSetores();
        }

        async function deletarSetor(id) {
            if(!confirm('Excluir este setor?')) return;
            await fetch(`/api/crm/setores/${id}`, { method: 'DELETE', headers });
            carregarSetores();
        }

        async function salvarOrdemSetores() {
            const ids = Array.from(document.getElementById('lista-setores').children).map(el => el.dataset.id);
            await fetch('/api/crm/setores/reordenar', { method: 'POST', headers, body: JSON.stringify({ ordem: ids }) });
            showToast('Ordem salva!', 'success');
        }

        // --- 6. EMPRESA ---
        async function carregarEmpresa() {
            const res = await fetch('/api/crm/config', {headers});
            const d = await res.json();
            document.getElementById('emp-nome').value = d.nome_sistema || '';
            document.getElementById('emp-cor').value = d.cor_primaria || '#4f46e5';
            document.getElementById('emp-msgs').value = d.mensagens_padrao || '';
            document.getElementById('emp-ausencia').value = d.msg_ausencia || '';
            document.getElementById('emp-avaliacao').value = d.msg_avaliacao || '';
            document.getElementById('emp-inicio').value = d.horario_inicio || '';
            document.getElementById('emp-fim').value = d.horario_fim || '';
        }

        async function salvarEmpresa() {
            const body = {
                nome: document.getElementById('emp-nome').value,
                cor: document.getElementById('emp-cor').value,
                mensagens: document.getElementById('emp-msgs').value,
                msg_ausencia: document.getElementById('emp-ausencia').value,
                msg_avaliacao: document.getElementById('emp-avaliacao').value,
                horario_inicio: document.getElementById('emp-inicio').value,
                horario_fim: document.getElementById('emp-fim').value
            };
            await fetch('/api/crm/config', { method: 'POST', headers, body: JSON.stringify(body) });
            showToast('Configurações salvas!', 'success');
        }

        // --- 7. AUTOMAÇÃO (IA) ---
        async function carregarAutomacao() {
            const res = await fetch('/api/crm/config', {headers});
            const d = await res.json();
            document.getElementById('ia-key').value = d.openai_key || '';
            document.getElementById('ia-prompt').value = d.openai_prompt || '';
            document.getElementById('ia-ativo').checked = !!d.openai_ativo;
        }

        async function salvarIA() {
            const body = {
                openai_key: document.getElementById('ia-key').value,
                openai_prompt: document.getElementById('ia-prompt').value,
                openai_ativo: document.getElementById('ia-ativo').checked
            };
            await fetch('/api/crm/config/ia', { method: 'POST', headers, body: JSON.stringify(body) });
            showToast('IA configurada!', 'success');
        }

        // --- 8. MENSAGENS RÁPIDAS ---
        async function carregarQuickMsgs() {
            const res = await fetch('/api/crm/mensagens-rapidas', {headers});
            const msgs = await res.json();
            document.getElementById('lista-quick').innerHTML = msgs.map(m => `
                <div class="bg-white border p-4 rounded-lg shadow-sm relative dark:bg-slate-800 dark:border-slate-700">
                    <div class="font-bold text-sm text-indigo-600 mb-1">${m.titulo}</div>
                    <div class="text-xs text-slate-500 font-mono mb-2 bg-slate-100 inline-block px-1 rounded dark:bg-slate-700 dark:text-slate-300">${m.atalho || 'sem atalho'}</div>
                    <p class="text-sm text-slate-700 dark:text-slate-300 line-clamp-3">${m.conteudo}</p>
                    <button onclick="deletarQuick(${m.id})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function criarQuickMsg() {
            const titulo = document.getElementById('quick-titulo').value;
            const atalho = document.getElementById('quick-atalho').value;
            const conteudo = document.getElementById('quick-conteudo').value;
            if(!titulo || !conteudo) return showToast('Preencha os campos', 'error');

            await fetch('/api/crm/mensagens-rapidas', { method: 'POST', headers, body: JSON.stringify({ titulo, atalho, conteudo }) });
            showToast('Mensagem criada!', 'success');
            document.getElementById('quick-titulo').value = '';
            document.getElementById('quick-conteudo').value = '';
            carregarQuickMsgs();
        }

        async function deletarQuick(id) {
            if(!confirm('Excluir mensagem?')) return;
            await fetch(`/api/crm/mensagens-rapidas/${id}`, { method: 'DELETE', headers });
            carregarQuickMsgs();
        }

        // --- 9. MARKETING (BROADCAST) ---
        async function enviarBroadcast() {
            const msg = document.getElementById('mkt-msg').value;
            if(!msg) return showToast('Escreva uma mensagem', 'error');
            if(!confirm('ATENÇÃO: Isso enviará a mensagem para TODOS os contatos. Continuar?')) return;

            document.getElementById('mkt-status').classList.remove('hidden');
            try {
                const res = await fetch('/api/crm/broadcast', { method: 'POST', headers, body: JSON.stringify({ mensagem: msg }) });
                const d = await res.json();
                showToast(`Enviado para ${d.enviados} contatos!`, 'success');
                document.getElementById('mkt-msg').value = '';
            } catch(e) { showToast('Erro no envio', 'error'); }
            document.getElementById('mkt-status').classList.add('hidden');
        }

        // --- 10. EQUIPE ---
        async function carregarEquipe() {
            const res = await fetch('/api/crm/atendentes', {headers});
            const users = await res.json();
            
            // Popula tabela
            document.getElementById('lista-equipe').innerHTML = users.map(u => `
                <tr class="bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                    <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">${u.nome} ${u.is_admin ? '<span class="text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded ml-1">ADMIN</span>' : ''}</td>
                    <td class="px-4 py-3 text-slate-500 dark:text-slate-400">${u.email}</td>
                    <td class="px-4 py-3">${u.setores || 'Todos'}</td>
                    <td class="px-4 py-3">
                        <button onclick="deletarUsuario(${u.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Popula lista de setores para novo usuário
            const resSet = await fetch('/api/crm/setores', {headers});
            const setores = await resSet.json();
            document.getElementById('lista-setores-user').innerHTML = setores.map(s => `
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" value="${s.id}" class="setor-check"> ${s.nome}
                </label>
            `).join('');
        }

        async function criarUsuario() {
            const nome = document.getElementById('user-nome').value;
            const email = document.getElementById('user-email').value;
            const senha = document.getElementById('user-senha').value;
            const tel = document.getElementById('user-tel').value;
            const isAdmin = document.getElementById('user-admin').checked;
            
            const checks = document.querySelectorAll('.setor-check:checked');
            const setores = Array.from(checks).map(c => c.value);

            if(!nome || !email || !senha) return showToast('Preencha os dados', 'error');

            await fetch('/api/crm/atendentes', { 
                method: 'POST', 
                headers, 
                body: JSON.stringify({ nome, email, senha, telefone: tel, is_admin: isAdmin, setores }) 
            });
            showToast('Usuário criado!', 'success');
            carregarEquipe();
        }

        async function deletarUsuario(id) {
            if(!confirm('Excluir usuário?')) return;
            await fetch(`/api/crm/atendentes/${id}`, { method: 'DELETE', headers });
            carregarEquipe();
        }

        // --- 11. ETIQUETAS (TAGS) ---
        function selectColor(color) {
            document.getElementById('tag-cor').value = color;
            document.getElementById('tag-cor-hex').innerText = color;
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        document.getElementById('tag-cor').addEventListener('input', (e) => {
            document.getElementById('tag-cor-hex').innerText = e.target.value;
        });

        async function carregarTagsAdmin() {
            try {
                const res = await fetch('/api/crm/etiquetas', {headers});
                const tags = await res.json();
                
                document.getElementById('count-tags').innerText = tags.length;
                const container = document.getElementById('lista-tags-admin');
                
                if (tags.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400 text-sm flex flex-col items-center"><i class="fas fa-tags text-4xl mb-3 opacity-20"></i><p>Nenhuma etiqueta criada ainda.</p></div>';
                    return;
                }

                container.innerHTML = tags.map(t => `
                    <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 bg-white shadow-sm hover:shadow-md transition dark:bg-slate-800 dark:border-slate-700 group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-4 h-4 rounded-full shadow-sm shrink-0" style="background-color: ${t.cor}"></div>
                            <span class="font-bold text-sm text-slate-700 dark:text-white truncate">${t.nome}</span>
                        </div>
                        <button onclick="deletarTag(${t.id})" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-100 transition dark:hover:bg-slate-700 opacity-0 group-hover:opacity-100" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');
            } catch (e) {}
        }

        async function salvarTag() {
            const nome = document.getElementById('tag-nome').value.trim();
            const cor = document.getElementById('tag-cor').value;
            
            if(!nome) return showToast('Nome da etiqueta é obrigatório', 'error');
            
            try {
                const res = await fetch('/api/crm/etiquetas', { 
                    method: 'POST', 
                    headers, 
                    body: JSON.stringify({ nome, cor }) 
                });
                if (res.ok) {
                    showToast('Etiqueta criada com sucesso!', 'success');
                    document.getElementById('tag-nome').value = '';
                    carregarTagsAdmin();
                } else { showToast('Erro ao criar etiqueta.', 'error'); }
            } catch (e) { showToast('Erro de conexão.', 'error'); }
        }

        async function deletarTag(id) {
            if(!confirm('Tem certeza que deseja excluir esta etiqueta?')) return;
            try {
                await fetch(`/api/crm/etiquetas/${id}`, { method: 'DELETE', headers });
                carregarTagsAdmin();
                showToast('Etiqueta removida.', 'success');
            } catch (e) { showToast('Erro ao remover.', 'error'); }
        }

        // --- UTILITÁRIOS ---
        function showToast(msg, type='info') { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = msg; 
            t.className = `fixed top-5 right-5 z-50 text-white px-4 py-3 rounded shadow-lg transform transition duration-300 border-l-4 flex items-center gap-3 ${type === 'error' ? 'bg-red-800 border-red-500' : 'bg-slate-800 border-indigo-500'}`;
            t.classList.remove('translate-x-full'); 
            setTimeout(() => t.classList.add('translate-x-full'), 3000); 
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

    </script>
</body>
</html>